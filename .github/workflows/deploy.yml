name: üöÄ Deploy kiosk_frontend to Server

on:
  push:
    branches:
      - main  # Trigger deploy whenever main branch is updated

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üöÄ Deploy to Remote Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASS }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e

            PROJECTS_DIR="/root/projects"
            PROJECT_NAME="kiosk_frontend"
            PROJECT_PATH="$PROJECTS_DIR/$PROJECT_NAME"
            IMAGE_NAME="kiosk_frontend"
            CONTAINER_NAME="kiosk_frontend"

            echo "===== üìÇ Ensuring base directory exists ====="
            mkdir -p "$PROJECTS_DIR"
            cd "$PROJECTS_DIR"

            if [ -d "$PROJECT_PATH/.git" ]; then
              echo "===== üîÑ Repo exists, pulling latest changes ====="
              cd "$PROJECT_PATH"
              git fetch origin main
              git reset --hard origin/main
            else
              echo "===== üì• Cloning repo for the first time ====="
              git clone https://github.com/MyAccess2021/kiosk_frontend.git "$PROJECT_PATH"
              cd "$PROJECT_PATH"
            fi

            echo "===== üßπ Removing old container and image ====="
            docker ps -q --filter "name=$CONTAINER_NAME" | grep -q . && docker rm -f "$CONTAINER_NAME" || echo "No running container."
            docker images -q "$IMAGE_NAME" | grep -q . && docker rmi -f "$IMAGE_NAME" || echo "No old image."

            echo "===== üõ†Ô∏è Building new Docker image ====="
            docker build -t "$IMAGE_NAME" "$PROJECT_PATH"

            echo "===== üèÉ Running container on port 87 ====="
            docker run -d --name "$CONTAINER_NAME" -p 87:80 "$IMAGE_NAME"

            echo "===== ‚úÖ Deployment Completed Successfully ====="
